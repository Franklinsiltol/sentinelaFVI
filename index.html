<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinela üïµÔ∏è</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --primary-color: #000000;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 24px;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
        }
        .config-section, .filters-section {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .input-group label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 6px;
        }
        input[type="text"], select {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: var(--card-bg-color);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.85;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #loader {
            text-align: center;
            font-size: 1.2rem;
            padding: 40px;
            display: none;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        .kpi-item {
            text-align: center;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .kpi-label {
            font-size: 1rem;
            color: #6c757d;
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        .grid-col-span-2 {
            grid-column: span 2;
        }
        #feedback-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            font-weight: 600;
            position: sticky;
            top: 0;
            background-color: var(--card-bg-color);
        }
        .stars {
            color: #FFD700;
            font-size: 1.5rem;
        }
        @media (max-width: 768px) {
            .grid-col-span-2 {
                grid-column: span 1;
            }
            header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Sentinela üïµÔ∏è - Dashboard de Performance</h1>
        </header>

        <div class="card config-section">
            <div class="input-group" style="flex-grow: 2;">
                <label for="sheetId">üìÑ Google Sheet ID</label>
                <input type="text" id="sheetId" value="1NsGJ5BDGLyx_FyY9hCrtmCzUmzx0X4Hw36JgYnKfuYk">
            </div>
            <div class="input-group" style="flex-grow: 1;">
                <label for="sheetName">üìù Nome da Aba</label>
                <input type="text" id="sheetName" placeholder="Opcional">
            </div>
            <button id="loadDataBtn">Carregar Dados</button>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="card filters-section">
                <div class="input-group">
                    <label for="coordFilter">üìç Coordena√ß√£o</label>
                    <select id="coordFilter"><option value="all">Todas</option></select>
                </div>
                <div class="input-group">
                    <label for="poloFilter">üè¢ Polo</label>
                    <select id="poloFilter"><option value="all">Todos</option></select>
                </div>
                <div class="input-group">
                    <label for="execFilter">üßë‚Äçüíº Executivo</label>
                    <select id="execFilter"><option value="all">Todos</option></select>
                </div>
            </div>

            <div class="card">
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <div id="kpi-total" class="kpi-value">-</div>
                        <div class="kpi-label">Avalia√ß√µes Totais</div>
                    </div>
                    <div class="kpi-item">
                        <div id="kpi-avg" class="kpi-value">-</div>
                        <div class="kpi-label">M√©dia Geral (0-100)</div>
                    </div>
                    <div class="kpi-item">
                        <div id="kpi-non-compliance" class="kpi-value">-</div>
                        <div class="kpi-label">N√£o Conformidades</div>
                    </div>
                    <div class="kpi-item">
                        <div id="kpi-feedback-received" class="kpi-value">-</div>
                        <div class="kpi-label">Feedback Recebido</div>
                    </div>
                    <div class="kpi-item">
                        <div id="kpi-leadership" class="kpi-value">-</div>
                        <div class="kpi-label">Percep√ß√£o de Lideran√ßa</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card grid-col-span-2">
                    <h2>üìä M√©dia de Desempenho por Etapa</h2>
                    <div class="chart-container">
                        <canvas id="performanceByStageChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>‚≠ê Distribui√ß√£o das Avalia√ß√µes</h2>
                    <div class="chart-container">
                        <canvas id="ratingDistributionChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>üì° Perfil de Desempenho (Radar)</h2>
                    <div class="chart-container">
                        <canvas id="performanceRadarChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>üè¢ Avalia√ß√µes por Coordena√ß√£o</h2>
                    <div class="chart-container">
                        <canvas id="evalsByCoordChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>üó£Ô∏è Feedback Recebido?</h2>
                    <div class="chart-container">
                        <canvas id="feedbackGivenChart"></canvas>
                    </div>
                </div>
                <div class="card grid-col-span-2">
                    <h2>üìà Timeline da M√©dia Geral</h2>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="card grid-col-span-2">
                    <h2>üìù Feedbacks Escritos</h2>
                    <div id="feedback-table-container">
                        <table id="feedbackTable">
                            <thead><tr><th>Executivo</th><th>Timestamp</th><th>Feedback</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="loader">Aguardando carregamento... ‚è≥</div>
    </div>

<script>
const DOM = {
    sheetIdInput: document.getElementById('sheetId'),
    sheetNameInput: document.getElementById('sheetName'),
    loadDataBtn: document.getElementById('loadDataBtn'),
    loader: document.getElementById('loader'),
    dashboardContent: document.getElementById('dashboard-content'),
    coordFilter: document.getElementById('coordFilter'),
    poloFilter: document.getElementById('poloFilter'),
    execFilter: document.getElementById('execFilter'),
    feedbackTableBody: document.querySelector('#feedbackTable tbody')
};

const CONSTANTS = {
    RATING_MAP: { 'Below': 1, 'Meets': 2, 'Above': 3 },
    FILTER_ALL: 'all'
};

let STAGE_KEYS = [];
let STAGE_LABELS = [];
let allData = [];
let charts = {};

DOM.loadDataBtn.addEventListener('click', loadData);
[DOM.coordFilter, DOM.poloFilter, DOM.execFilter].forEach(el => {
    el.addEventListener('change', applyFiltersAndRender);
});

function normalizeHeader(header) {
    if (typeof header !== 'string') return '';
    return header.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
}

function calculateLeadershipStars(data) {
    if (!data.length) return 0;
    
    let totalScore = 0;
    let totalRatings = 0;
    
    const leadershipStages = STAGE_KEYS.filter((key, index) => {
        const label = STAGE_LABELS[index].toLowerCase();
        return label.includes('sondar') || label.includes('unir') || 
               label.includes('mostrar') || label.includes('ultrapassar') || 
               label.includes('propor');
    });
    
    data.forEach(row => {
        leadershipStages.forEach(key => {
            if (CONSTANTS.RATING_MAP[row[key]]) {
                totalScore += CONSTANTS.RATING_MAP[row[key]];
                totalRatings++;
            }
        });
    });
    
    const avgScore = totalRatings > 0 ? totalScore / totalRatings : 0;
    const stars = (avgScore / 3) * 5;
    return Math.round(stars * 10) / 10;
}

function generateStars(rating) {
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5 ? 1 : 0;
    const emptyStars = 5 - fullStars - halfStar;
    
    return '‚òÖ'.repeat(fullStars) + '¬Ω'.repeat(halfStar) + '‚òÜ'.repeat(emptyStars);
}

async function loadData() {
    const sheetId = DOM.sheetIdInput.value.trim();
    const sheetName = DOM.sheetNameInput.value.trim();

    if (!sheetId) {
        alert('Por favor, insira o ID da planilha.');
        return;
    }

    DOM.loadDataBtn.disabled = true;
    DOM.loader.style.display = 'block';
    DOM.dashboardContent.style.display = 'none';
    DOM.loader.textContent = 'Carregando dados... ‚è≥';

    let url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
    if (sheetName) {
        url += `&sheet=${encodeURIComponent(sheetName)}`;
    }

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Falha na requisi√ß√£o: ${response.statusText}`);
        }
        let text = await response.text();
        
        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?\s*$/);
        if (!match) {
            throw new Error('Formato inv√°lido. Verifique se a planilha √© p√∫blica.');
        }

        const json = JSON.parse(match[1]);

        if (json.status === 'error') {
            throw new Error(`Erro: ${json.errors.map(e => e.detailed_message).join(', ')}`);
        }

        const table = json.table;
        if (!table || !table.rows || table.rows.length === 0) {
            throw new Error('Nenhum dado encontrado.');
        }

        const raw_headers = table.cols.map(col => col.label);
        const dataRows = table.rows.map(row => row.c.map(cell => (cell ? (cell.f || cell.v) : '')));
        const headers = raw_headers.map(normalizeHeader);

        // Identificar colunas de avalia√ß√£o
        STAGE_KEYS = [];
        STAGE_LABELS = [];
        
        headers.forEach((header, index) => {
            const originalHeader = raw_headers[index];
            if (originalHeader && originalHeader.includes('Avalie o desempenho')) {
                STAGE_KEYS.push(header);
                let label = originalHeader
                    .replace(/Avalie o desempenho na etapa /i, '')
                    .replace(/Avalie o desempenho na /i, '')
                    .replace(/Avalie o desempenho /i, '')
                    .trim();
                STAGE_LABELS.push(label);
            }
        });

        allData = dataRows.map(row => {
            const entry = {};
            headers.forEach((header, i) => {
                if (header) entry[header] = row[i] || '';
            });
            return entry;
        });

        console.log('‚úÖ Etapas encontradas:', STAGE_LABELS);
        console.log('‚úÖ Exemplo:', allData[0]);

        populateFilters();
        applyFiltersAndRender();

        DOM.loader.style.display = 'none';
        DOM.dashboardContent.style.display = 'block';

    } catch (error) {
        DOM.loader.textContent = `‚ùå Erro: ${error.message}`;
        console.error(error);
        alert(`Erro ao carregar dados:\n${error.message}`);
    } finally {
        DOM.loadDataBtn.disabled = false;
    }
}

function populateFilters() {
    const filters = { coord: new Set(), polo: new Set(), exec: new Set() };

    allData.forEach(row => {
        if (row.coordenacao) filters.coord.add(row.coordenacao);
        if (row.polo) filters.polo.add(row.polo);
        if (row.email_do_executivo) filters.exec.add(row.email_do_executivo);
    });

    const populate = (selectElement, values) => {
        selectElement.innerHTML = `<option value="${CONSTANTS.FILTER_ALL}">Todos</option>`;
        [...values].sort().forEach(value => {
            selectElement.innerHTML += `<option value="${value}">${value}</option>`;
        });
    };

    populate(DOM.coordFilter, filters.coord);
    populate(DOM.poloFilter, filters.polo);
    populate(DOM.execFilter, filters.exec);
}

function applyFiltersAndRender() {
    const coord = DOM.coordFilter.value;
    const polo = DOM.poloFilter.value;
    const exec = DOM.execFilter.value;

    const filteredData = allData.filter(row => {
        const all = CONSTANTS.FILTER_ALL;
        return (coord === all || row.coordenacao === coord) &&
               (polo === all || row.polo === polo) &&
               (exec === all || row.email_do_executivo === exec);
    });

    if (Object.keys(charts).length === 0) createCharts();
    updateDashboard(filteredData);
}

function updateDashboard(data) {
    updateKPIs(data);
    updatePerformanceByStageChart(data);
    updateRatingDistributionChart(data);
    updatePerformanceRadarChart(data);
    updateEvalsByCoordChart(data);
    updateFeedbackGivenChart(data);
    updateFeedbackTable(data);
    updateTimelineChart(data);
}

function updateKPIs(data) {
    document.getElementById('kpi-total').textContent = data.length;

    // M√©dia geral em escala 0-100
    let totalScore = 0, totalRatings = 0;
    data.forEach(row => {
        STAGE_KEYS.forEach(key => {
            if (CONSTANTS.RATING_MAP[row[key]]) {
                // Converter para escala 0-100: (rating-1)/2 * 100
                const score = ((CONSTANTS.RATING_MAP[row[key]] - 1) / 2) * 100;
                totalScore += score;
                totalRatings++;
            }
        });
    });
    const avgScore = totalRatings > 0 ? Math.round(totalScore / totalRatings) : 0;
    document.getElementById('kpi-avg').textContent = avgScore;

    // N√£o conformidades - CORRE√á√ÉO: contar sempre que houver qualquer valor preenchido
    const nonComplianceCount = data.filter(row => {
        // Verificar v√°rias poss√≠veis colunas de n√£o conformidade
        const ncField1 = row['marque_se_houve_alguma_nao_conformidade_gravedesconto_de_100_pontos'];
        const ncField2 = row['nao_conformidade'];
        const ncField3 = row['nao_conformidades'];
        
        // Verificar se algum dos campos tem valor preenchido
        return (ncField1 && ncField1.toString().trim() !== '') ||
               (ncField2 && ncField2.toString().trim() !== '') ||
               (ncField3 && ncField3.toString().trim() !== '');
    }).length;
    
    document.getElementById('kpi-non-compliance').textContent = nonComplianceCount;

    // Feedback recebido - ajustado para considerar respostas "N√£o"
    const feedbackResponses = data.filter(row => {
        const feedback = row['executivo_recebeu_feedback_esse_mes'];
        return feedback && (feedback === 'Sim' || feedback === 'N√£o');
    });
    const feedbackReceivedCount = feedbackResponses.filter(row => 
        row['executivo_recebeu_feedback_esse_mes'] === 'Sim'
    ).length;
    const feedbackPercentage = feedbackResponses.length > 0 ? 
        Math.round((feedbackReceivedCount / feedbackResponses.length) * 100) + '%' : '0%';
    document.getElementById('kpi-feedback-received').textContent = feedbackPercentage;

    // Percep√ß√£o de lideran√ßa com estrelas
    const leadershipRating = calculateLeadershipStars(data);
    document.getElementById('kpi-leadership').innerHTML = 
        `<span class="stars">${generateStars(leadershipRating)}</span><br>${leadershipRating.toFixed(1)}/5.0`;
}

function createOrUpdateChart(id, type, data, options) {
    const ctx = document.getElementById(id).getContext('2d');
    if (charts[id]) {
        charts[id].data = data;
        charts[id].options = options;
        charts[id].update();
    } else {
        charts[id] = new Chart(ctx, { type, data, options });
    }
}

function createCharts() {
    const emptyData = { labels: [], datasets: [] };
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'top' } }
    };

    createOrUpdateChart('performanceByStageChart', 'bar', emptyData, { 
        ...commonOptions, 
        scales: { y: { beginAtZero: true, max: 100 } } 
    });
    createOrUpdateChart('ratingDistributionChart', 'doughnut', emptyData, commonOptions);
    createOrUpdateChart('performanceRadarChart', 'radar', emptyData, { 
        ...commonOptions, 
        scales: { r: { beginAtZero: true, max: 100 } } 
    });
    createOrUpdateChart('evalsByCoordChart', 'bar', emptyData, { ...commonOptions, indexAxis: 'y' });
    createOrUpdateChart('feedbackGivenChart', 'pie', emptyData, commonOptions);
    createOrUpdateChart('timelineChart', 'line', emptyData, {
        ...commonOptions,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: 'M√©dia Geral (0-100)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'M√™s'
                }
            }
        }
    });
}

function updatePerformanceByStageChart(data) {
    const stageTotals = STAGE_KEYS.map(() => ({ sum: 0, count: 0 }));

    data.forEach(row => {
        STAGE_KEYS.forEach((key, i) => {
            const rating = CONSTANTS.RATING_MAP[row[key]];
            if (rating) {
                // Converter para escala 0-100
                const score = ((rating - 1) / 2) * 100;
                stageTotals[i].sum += score;
                stageTotals[i].count++;
            }
        });
    });

    const averages = stageTotals.map(s => s.count > 0 ? Math.round(s.sum / s.count) : 0);

    const chartData = {
        labels: STAGE_LABELS, // REMOVIDO: .map(label => formatStageLabel(label))
        datasets: [{
            label: 'M√©dia de Desempenho (0-100)',
            data: averages,
            backgroundColor: 'rgba(0, 0, 0, 0.7)',
            borderColor: 'rgba(0, 0, 0, 1)',
            borderWidth: 1
        }]
    };
    createOrUpdateChart('performanceByStageChart', 'bar', chartData, {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    });
}

function updateRatingDistributionChart(data) {
    const counts = { 'Below': 0, 'Meets': 0, 'Above': 0 };
    data.forEach(row => {
        STAGE_KEYS.forEach(key => {
            if (counts[row[key]] !== undefined) counts[row[key]]++;
        });
    });

    const chartData = {
        labels: ['Above', 'Meets', 'Below'],
        datasets: [{
            label: 'Distribui√ß√£o',
            data: [counts['Above'], counts['Meets'], counts['Below']],
            backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
            hoverOffset: 4
        }]
    };
    createOrUpdateChart('ratingDistributionChart', 'doughnut', chartData, { responsive: true, maintainAspectRatio: false });
}

function updatePerformanceRadarChart(data) {
    const stageTotals = STAGE_KEYS.map(() => ({ sum: 0, count: 0 }));
    data.forEach(row => {
        STAGE_KEYS.forEach((key, i) => {
            const rating = CONSTANTS.RATING_MAP[row[key]];
            if (rating) {
                // Converter para escala 0-100
                const score = ((rating - 1) / 2) * 100;
                stageTotals[i].sum += score;
                stageTotals[i].count++;
            }
        });
    });
    const averages = stageTotals.map(s => s.count > 0 ? Math.round(s.sum / s.count) : 0);

    const chartData = {
        labels: STAGE_LABELS, // REMOVIDO: .map(label => formatStageLabel(label))
        datasets: [{
            label: 'M√©dia de Performance (0-100)',
            data: averages,
            fill: true,
            backgroundColor: 'rgba(0, 0, 0, 0.2)',
            borderColor: 'rgb(0, 0, 0)',
            pointBackgroundColor: 'rgb(0, 0, 0)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(0, 0, 0)'
        }]
    };
    createOrUpdateChart('performanceRadarChart', 'radar', chartData, {
        responsive: true,
        maintainAspectRatio: false,
        scales: { r: { beginAtZero: true, max: 100, min: 0 } }
    });
}

function updateEvalsByCoordChart(data) {
    const counts = {};
    data.forEach(row => {
        const coord = row.coordenacao || 'N/A';
        counts[coord] = (counts[coord] || 0) + 1;
    });

    const sortedCoords = Object.entries(counts).sort((a, b) => b[1] - a[1]);

    const chartData = {
        labels: sortedCoords.map(c => c[0]),
        datasets: [{
            label: 'N¬∫ de Avalia√ß√µes',
            data: sortedCoords.map(c => c[1]),
            backgroundColor: 'rgba(0, 0, 0, 0.7)'
        }]
    };
    createOrUpdateChart('evalsByCoordChart', 'bar', chartData, {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { legend: { display: false } }
    });
}

function updateFeedbackGivenChart(data) {
    const feedbackResponses = data.filter(row => {
        const feedback = row['executivo_recebeu_feedback_esse_mes'];
        return feedback && (feedback === 'Sim' || feedback === 'N√£o');
    });
    
    const counts = { 'Sim': 0, 'N√£o': 0 };
    feedbackResponses.forEach(row => {
        const val = row['executivo_recebeu_feedback_esse_mes'];
        if (val === 'Sim') counts['Sim']++;
        else if (val === 'N√£o') counts['N√£o']++;
    });

    const chartData = {
        labels: ['Sim', 'N√£o'],
        datasets: [{
            data: [counts['Sim'], counts['N√£o']],
            backgroundColor: ['#28a745', '#dc3545']
        }]
    };
    createOrUpdateChart('feedbackGivenChart', 'pie', chartData, { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = counts['Sim'] + counts['N√£o'];
                        const percentage = Math.round((context.parsed / total) * 100);
                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                    }
                }
            }
        }
    });
}

function updateFeedbackTable(data) {
    DOM.feedbackTableBody.innerHTML = '';
    const fragment = document.createDocumentFragment();
    
    data.forEach(row => {
        const feedback = row['escreva_um_feedback_sobre_o_executivo'];
        if (feedback) {
            const tr = document.createElement('tr');
            // Incluir timestamp se dispon√≠vel
            const timestamp = row.carimbo_de_datahora || row.timestamp || 'N/A';
            tr.innerHTML = `
                <td>${row.email_do_executivo || 'N/A'}</td>
                <td>${timestamp}</td>
                <td>${feedback}</td>
            `;
            fragment.appendChild(tr);
        }
    });
    
    DOM.feedbackTableBody.appendChild(fragment);
}

function updateTimelineChart(data) {
    // Agrupar dados por m√™s
    const monthlyData = {};
    
    data.forEach(row => {
        // Tentar encontrar timestamp - verificar v√°rias colunas poss√≠veis
        const timestamp = row.carimbo_de_datahora || row.timestamp || row.data;
        if (!timestamp) return;
        
        try {
            const date = new Date(timestamp);
            const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
            
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = { sum: 0, count: 0 };
            }
            
            // Calcular m√©dia geral para esta linha
            let rowSum = 0;
            let rowCount = 0;
            
            STAGE_KEYS.forEach(key => {
                const rating = CONSTANTS.RATING_MAP[row[key]];
                if (rating) {
                    const score = ((rating - 1) / 2) * 100;
                    rowSum += score;
                    rowCount++;
                }
            });
            
            if (rowCount > 0) {
                const rowAvg = rowSum / rowCount;
                monthlyData[monthYear].sum += rowAvg;
                monthlyData[monthYear].count++;
            }
        } catch (e) {
            console.log('Erro ao processar timestamp:', timestamp);
        }
    });
    
    // Ordenar meses cronologicamente
    const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
        const [monthA, yearA] = a.split('/').map(Number);
        const [monthB, yearB] = b.split('/').map(Number);
        return new Date(yearA, monthA - 1) - new Date(yearB, monthB - 1);
    });
    
    const averages = sortedMonths.map(month => {
        const data = monthlyData[month];
        return data.count > 0 ? Math.round(data.sum / data.count) : 0;
    });
    
    // Calcular linha de tend√™ncia (regress√£o linear simples)
    const trendData = calculateTrendLine(averages);
    
    const chartData = {
        labels: sortedMonths,
        datasets: [
            {
                label: 'M√©dia Mensal',
                data: averages,
                borderColor: 'rgb(0, 0, 0)',
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                tension: 0.4,
                fill: false
            },
            {
                label: 'Linha de Tend√™ncia',
                data: trendData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                pointRadius: 0
            }
        ]
    };
    
    createOrUpdateChart('timelineChart', 'line', chartData, {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: 'M√©dia Geral (0-100)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'M√™s'
                }
            }
        }
    });
}

function calculateTrendLine(data) {
    if (data.length < 2) return data;
    
    const n = data.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
    
    for (let i = 0; i < n; i++) {
        sumX += i;
        sumY += data[i];
        sumXY += i * data[i];
        sumXX += i * i;
    }
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    return Array.from({length: n}, (_, i) => intercept + slope * i);
}
</script>

</body>
</html>
